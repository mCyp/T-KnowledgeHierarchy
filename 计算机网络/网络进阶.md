# 网络进阶

## # CDN

**CDN**全称Content Delivery Network，即内容分发网络。

当我们的业务设涉及的区域足够广的时候，比如全中国，甚至全球的时候，建立CDN就是有必要的了。

### 1.构建过程

构建CDN的过程如下：

1. 构建一个中心节点，中心节点会将所有的信息都存储在这里。
2. 以中心节点为父节点，建立区域节点，区域节点根据需要存储相关的信息，不需要存储中心节点那么多的信息。
3. 如有需要，以区域节点为父节点，建立边缘节点，边缘节点服务器集群存储的消息则是边缘节点的子集。

经过如上的一顿操作，CDN就建立完成了。

![CDN网络](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E8%BF%9B%E9%98%B6/CDN%E7%BD%91%E7%BB%9C.jpg)

### 2. 访问过程

CDN建立完毕以后，客户端如何访问呢，访问过程如下：

1. 基于DNS的全局负载均衡，CDN自己的权威DNS服务器会为客户端会为用户分配一个合适的IP地址。分配的标准有：服务器地址距离用户IP地址的远近、用户的运营商、服务器当前状态等。
2. 假设当前节点没有用户所需消息，那么这台服务器就需要向它的上一级服务器发起请求，即按照边缘-区域-中心的顺序，最后将内容拉取到本地。

### 3. 适用范围

CDN比较适合存储长期不会变化到的静态资源，比如图片、视频等。

对于经常变化的动态资源，也会有动态CDN，主要有两种，一种是将数据的存储和计算直接放在边缘节点，另一种数据的存储和计算还是放在中心节点，但是线路做了优化。

## # VPN

办公室需要连接公司的数据中心，一般有三种方式：

- 走公网：不太安全，隐私可能被看到
- 租用专线网络：太贵
- 使用VPN：是上面两种方案的折中

**VPN**全称Virtulal Private Network，即虚拟专用网络，就是利用开放的公众网络，建立专有的数据通道，将远程的分支机构、移动办公人员连接起来。

为了仿真一条点到点的专线，VPN需要涉及到三种协议：承载协议、隧道协议和乘客协议。这三种协议是如何使用的呢？打个比方，开车过河的时候使用汽渡，车在马路遵循的交通规则叫作**乘客协议**，当汽车开进船内的时候，显然，**乘客协议**暂时不起作用了，只能待在船舱里面，开船的时候船得遵循规则啊，叫什么呢？叫**承载协议**，车在船舱里面，没有暴露在外面就到达了河对岸，我们可以叫其**隧道协议**。

VPN根据技术划分又可以分化很多类，在这里，以IPsec（Internet Protocol Security） VPN为例，简单看一下IPsec VPN的结构：

*图片来自[《趣谈网络协议》](https://time.geekbang.org/column/article/10386)*

![结构](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E8%BF%9B%E9%98%B6/IPsec%20VPN.jpg)

上面的几个协议中，重点了解一下**隧道协议**。

### 1. 隧道协议

隧道协议中，我们应该关注两点，一是秘钥如何建立的，二是如何维护连接。这两点分别对应着IPsec VPN的两大组件：**IKE组件**和**SA（Security Assocition）组件**。

#### 1.1 IKE组件

IPSec VPN是使用对称加密对数据进行加密的，所以加密和解密都使用的同一个钥匙，如何生成秘钥则是IKE组件需要解决的问题，一旦生成好秘钥，也就是生成了自己的SA，看看IKE组件是如何解决该问题的：

*图片来自[《趣谈网络协议》](https://time.geekbang.org/column/article/10386)*

![对称秘钥交换过程](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E8%BF%9B%E9%98%B6/IPsec%E7%A7%98%E9%92%A5%E7%94%9F%E6%88%90.jpg)

#### 1.2 SA组件

SA组件有一下内容：

- SPI（Security Parameter Index）标识不同连接。
- 双方商量好加密算法、哈希算法和封装模式。
- 生存周期过了以后，就需要重新生成秘钥

### 2. IPsec VPN缺点

IPsec VPN是基于IP协议的，包是默认不可达的，在三层网络中，每到一个设备都会计算下一跳如何走，再加上加密和解密的时间，VPN的速度慢是可以理解的。那么，有比较快的方法吗？当然是有的，加密和解密这个时间暂时不好优化，所以只能替换IP协议，这个替换的协议是**MPLS**（Muti-Protocal Label Switching），即多协议标签交换。如需进一步了解，可查阅文章：

>[《MPLS基础》](https://zhuanlan.zhihu.com/p/27232535)
>
>[《MPLS control plane》](https://zhuanlan.zhihu.com/p/27340628)

## # 云计算

### ## 虚拟机

由于在数据中心维护起来有很多麻烦，故人们发明了一种叫虚拟机的东西，并由此产生了云计算。那么使用虚拟机有什么好处呢：

- 灵活配置设备：CPU的数目、内存大小、硬盘大小这些都可以配置
- 不用可以删除，不会占用资源
- 删除以后可重复创建

一台巨大的物理机可以创建许多虚拟机的同时也为我们带来了许多注意的地方：

- 共享：一台物理机的网卡数量有限，如何共享网口？
- 隔离：同一台物理机有很多数据，如何保证各个虚拟机的数据安全隔离呢？
- 互通：同一台物理机之间的多个虚拟机互相通信和不同物理机的虚拟机之间的通信？
- 灵活：虚拟机可能会经常创建和删除，需要保证配置的时候灵活

#### 1. 共享与互通

为了能够共享物理机上的网卡，虚拟机会虚拟出一张网卡，从而让别人觉得它有网卡，而收到网络包以后，又将这些网络包转化为流，写入字符设备。

虚拟机管理的技术可以选择：**桥接**和**NAT**。

如需进一步了解，可查阅：

> [《vmware 虚拟机三种网络模式—“桥接、NAT 、仅主机”区别？》](https://zhuanlan.zhihu.com/p/56658358)

#### 2. 隔离

使用VLAN和vconfig

### # SDN

**SDN**全称Software Defined Network，即软件定义网络。它解决了原生的VLAN和Linux网桥进行云平台管理时的灵活性和隔离性不足的问题，增加了网络统一的管理。

如需进一步了解，可查询：

> [《SDN 是什么？》](https://www.zhihu.com/question/20279620)

### # 云中机器的流量控制

现实生活中经常会用到流量控制，云计算中也是如此。

有一点需要注意，一台机器的网络流量控制，可以分为两个方向，出和进，而**我们能够控制的，只有出**，进入的方向我们无法控制，最多丢包。

控制网络的Qos（服务质量）的方式有：

- 无类别排队规则
  - 无类别排队
  - 随机公平队列
  - 令牌桶规则
- 基于类别的队列规则
  - 分层令牌桶规则

### # 云中网络隔离

VLAN虽然可以进行网络隔离，但是它只有12位，只支持4096个，在今天，远远是不够的。修改协议肯定是行不通的，只能扩展了。常用的两张技术分别是在三层上修改的**GRE**和在二层上修改的**VXLAN**。

## # 微服务



