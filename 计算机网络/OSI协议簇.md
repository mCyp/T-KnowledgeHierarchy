# OSI 体系结构

1984年，ISO（国际标准组织）发布了著名的**ISO/IEC 7489**标准，它定义了网络互连的七层框架，也就是开放式系统互连参考模型。

该模型自上而下可以分为应用层、表达层、会话层、传输层、网络层、数据链路层和物理层。这里我为什么选择自上而下的介绍呢，因为数据发送的顺序就是自上而下的，数据接收的时候则是相反，自下而上，相信很多同学在上大学的时候就了解过相关的信息了。

*图片来自[《漫谈网络通信——从 OSI 网络模型到 TCP/IP 协议族》](https://juejin.im/entry/584f9c04b123db00662890de)*

![OSI接送和发送](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/OSI%E6%8E%A5%E6%94%B6%E5%92%8C%E5%8F%91%E9%80%81.png)

## 应用层

应用层（Application Layer）提供为应用软件而设的接口，以设置与另一应用软件的通信。

### 1. 协议

#### # HTTP

HTTP（HyperText Transfer Protocal）是超文本传输协议的缩写，这是一个即使不是相关专业出身也能叫的出名字的协议了，关于更加详细的介绍，请移步我阅读完《图解HTTP》所做的笔记：

> [《HTTP》]([https://github.com/mCyp/T-KnowledgeHierarchy/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/HTTP.md](https://github.com/mCyp/T-KnowledgeHierarchy/blob/master/计算机网络/HTTP.md))

#### # DNS

DNS（Domin Name System）是域名解析协议的缩写，该协议的作用就是将域名转化为IP地址。想要弄懂DNS，其实只要弄懂其中三个部分即可，它们分别是DNS服务器结构、DNS请求流程和负载均衡。

##### ## DNS服务器结构

DNS服务器是高可用、高并发和分布式的树状层次结构：

*图片来自[《趣谈网络协议》](https://time.geekbang.org/column/article/9895)*

![](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/OSI/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BB%93%E6%9E%84.jpg)

- 根DNS服务器：返回顶级域DNS服务器的IP地址
- 顶级域DNS服务器：分别管理`.com`、`.cn`、`.net`的DNS服务器，作用是返回权威DNS服务器
- 权威DNS服务器：返回相应主机的IP地址

##### ## 请求流程

在**DNS服务器结构**中，可以很明显的看出DNS服务器的查询是自上而下的，即查找的顺序：根DNS服务器 --> 顶级域DNS服务器 --> 权威DNS服务器。流程：

*图片来自网络*

![服务器地址](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/OSI/DNS%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B.png)

##### ## 负载均衡

负载均衡是一个很有意思的东西，就是我们平常说的分布式，比如说一个市只有一个购物中心，大家购物都会选择去那里，每天都是人挤人，异常火爆，显而易见，购物中心容不下这么多人流量，购物中心一看，发财的机会来了，于是在市里的每个区都建造了一个购物中心，不同区的人就可以选择就近的购物中心，有效的缓解了中心购物中心的压力。

在DNS中，可以做两种负载均衡，一种是**内部负载均衡**，另外一种是**全局负载均衡**。

**内部负载均衡**比较简单，比如说你在给你的接口配置地址的时候，你会选择域名还是IP地址，选择IP地址的带来的问题是一旦这个服务器出现了故障，你的应用程序就得修改IP地址，而选择域名就不会出现这种问题，直接通过域名解析成动态的获取IP地址，在拥有多个服务器的情况下，DNS服务器，可以轮流更换IP地址，将压力分摊到多个服务器上。

当你的应用足够大的时候，你就得考虑**全局负载均衡**了，一般是建立多个机房，就会拥有多个服务器，系统会根据用户的运营商、地区帮助用户选择最近的服务器，从而给用户带来最快的访问速度。

##### ## 缺点

不过，DNS也会有以下问题：

- 域名缓存问题
- 域名转发问题
- 出口NAT
- 域名更新问题
- 解析延迟

为了解决上述的问题，基于HTTP协议的DNS服务器集群**HTTPDNS**就应运而生，他分布在多个地点和多个运营商，当客户端需要DNS解析的时候，直接通过HTTP协议请求服务器集群，得到最近的IP地址。

如需进一步了解**HTTPDNS**，可查阅

> [《百万级QPS的HTTPDNS服务》](https://zhuanlan.zhihu.com/p/47423090)

#### # FTP

文件传输协议（FTP），是常用下载文件的方式， FTP采用两个TCP链接完成文件的传输：

- 控制链接：服务器以被动的方式，打开21端口，等待客户链接
- 数据链接：客户端与服务端完成文件传输的时候会启用数据链接

通常，FTP有两种工作模式，它们分别是**主动模式**（PORT）和**被动模式**（PASV）：

- 主动模式：客户端使用N端口连接服务器的21端口，同时开发自己的N+1端口，服务器接收到消息以后，利用自己的数据端口20和客户端主动建立连接。
- 被动模式：客户端使用N端口连接服务器的21端口，服务器接收到消息，返回一个“227 entering passive mode”，这时候客户端使用自己的除N之外的任意端口与服务器的另一个端口P端口建立连接。

#### # P2P

 **P2P**（Peer to Peer）是点对点协议的缩写，是无中心服务器依靠用户群（peers）交互信息的互联网协议，它的作用在于减少以上网络传输中的节点，以降低资料遗失的风险。

简单来说一次是P2P的工作原理：

1. 资源没有集中的存储在某些设备上，而是分散的放在一些设备上，这些设备被称为Peer。
2. 如需下载文件，你可以和那些已经存在资源的Peer，建立点对点的连接，下载完文件以后，你也就成功的称为Peer。

在我们生活中，比较常见的是种子文件（.torrent）,种子文件包括两个部分：

- announce（tracker URL）：通过该路径去请求tracker服务器从而了解到哪些Peer可以下载文件。
- 文件信息

可以看到的是：**即使没有中心服务器，P2P协议仍然需要tracker服务器去了解哪些Peer可以下载文件资源，一旦tracker服务器出现故障，P2P就无法工作。**

为了解决上述存在的问题，引入了DHT（去中心化网络），大致的原理就是每个Peer除了要保存一些资源文件以外，还需要记录一些文件的索引，比如说我是A电脑，里面有文件1，2，索引则是文件6、7可以通过电脑B、E获取。

如需进一步了解，可翻阅：

> [《P2P中DHT网络介绍》](https://blog.csdn.net/mergerly/article/details/7989281)

#### # RTMP

RTMP（Real Time Message Protocol）是实时信息传输协议的缩写，它是由Adobe公司提出的应用层的协议，用来解决多媒体数据传输时的多路复用和分包协议。

**关键词**：RTMP握手、Chunk分包

如果想对RTMP协议进一步了解，可以阅读：

> [《带你吃透RTMP》]([https://mingyangshang.github.io/2016/03/06/RTMP%E5%8D%8F%E8%AE%AE/](https://mingyangshang.github.io/2016/03/06/RTMP协议/))
>
> [《直播推流实现RTMP协议的一些注意事项》](https://www.jianshu.com/p/00aceabce944)

## 表示层

表达层（Presentation Layer）把数据转换为能与接受者的系统格式兼容并适合输出的格式

## 会话层

会话层（Session Layer）是OSI模型的第五层，负责在数据传输中设置和维护电脑网络中两台电脑之间的通信连接。

## 传输层

传输层（Transport Layer）是OSI模型的第四层，**为应用进程提供端到端的服务**。

### 1. 协议

传输层最知名的协议就是**UDP**和**TCP**。

通常我们说这两个协议的时候，都会说，UDP面向无连接，TCP面向连接，那何谓连接呢？

> 所谓的建立连接，是为了在客户端和服务端维护连接，而建立一定的数据结构维护双方交互的状态，用这样的数据结构维护双方交互的状态

#### # UDP

UDP（User Datagram Protocal）称为用户数据包协议，是一个简单的面向数据报的协议。

##### ## 报文结构

![UDP报文结构](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/OSI/UDP%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.jpg)

- 源端口号
- 目的端口

##### ## 特点

UDP的特点：

- 无连接：不管对方有没有收到
- 不安全：可以给任何人传输数据，任何人也可以给它发送数据
- 基于数据包
- 不会根据网络状态更改状态

##### ## 场景

1. 需求资源少，容忍少数丢包
2. 无需一对一沟通，可广播
3. 处理速度快，延迟低

#### # TCP

TCP（Transmission Control Protocol）称为**传输控制协议**，是一种面向连接的、可靠的（无差错、不丢包、按序到达）、基于字节流的传输层通信协议。

##### ## 报文结构

![TCP报文结构](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/OSI/TCP%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.jpg)

- 序号：实现报文的有序控制
- 确认序号：确认当前收到数据
- URG：了解多少数据需要被紧急处理
- ACK：确认连接
- PSH：该位被设置为1的时候发送方会立即将数据推出，不会等缓存存满。接收方会立即将数据推倒应用程序里面。
- RST：重新链接
- SYN：发起一个链接
- FIN：终止信号

##### ## 特点

- 可靠：无差错、不丢包、有序
- 面向连接
- 基于数据流

##### ## 重点过程

三次握手

![三次握手](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.jpg)

四次挥手

![四次挥手](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpg)

流量控制

- 滑动窗口

拥塞控制

- 慢开始 & 拥塞避免
- 快重传 & 快恢复

状态总结

![状态机](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/%E7%8A%B6%E6%80%81%E6%9C%BA.jpg)

#### # QUIC

**QUIC**（Quick UDP Internet Connections）被称为**快速UDP网络连接**，是一种基于UDP的OSi模型的**传输层**协议（谷歌出品，必属精品）。可以这么说，它既继承了UDP的快，又拥有了TCP的安全和可靠，所以呢，2018年10月份，IETF（互联网工程任务小组）正式将基于QUIC的HTTP协议重名为**HTTP/3**。

简单的说一下QUIC的特点：

- 自定义连接机制：抛弃TCP的四元组（源IP、源端口、目标IP和目标端口）连接，以一个64位的随机数作为ID来标识，避免了四元组发生变化的时候重新连接的消耗。
- 自定义重传机制
- 无阻塞的多路复用
- 自定义流量控制
- 报文加密认证

如需进一步探索，可阅读：

> [《科普：QUIC协议原理分析》](https://zhuanlan.zhihu.com/p/32553477)

### 2. 使用

#### # Socket

Socket又名套接字，用来建立端到端的通信，可以指定`UDP`或者`TCP`。

##### ## 基本方法

公共方法

| 名称 | 意义               |
| ---- | ------------------ |
| bind | 绑定IP地址和端口号 |

TCP常用方法

| 名称    | 意义                                                         |
| ------- | ------------------------------------------------------------ |
| listen  | 一般是 *服务器* 用来监听IP地址和端口，查看是否有 *客户端* 连接，在指定TCP的情况下 |
| connect | *客户端* 发起连接                                            |
| accept  | *服务端* 接收连接                                            |
| write   | 写入方法                                                     |

UDP常用方法

| 名称     | 意义     |
| -------- | -------- |
| sendto   | 发送数据 |
| recvfrom | 接收数据 |

##### ## 连接过程

基于TCP的连接过程

![Socket-TCP](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/Socket%E5%9F%BA%E4%BA%8ETCP%E8%BF%9E%E6%8E%A5.jpg)

基于UDP的连接过程

![Socket-UDP](https://teaof-konwleadge-1255982134.cos.ap-shanghai.myqcloud.com/blog/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/Socket%E5%9F%BA%E4%BA%8EUDP%E8%BF%9E%E6%8E%A5.jpg)

##### ## 知识点

基于TCP

- 监听的Socket和传数据的Socket是两个，一个叫作监听Socket，一个叫作已连接Socket。

基于UDP协议

- UDP是不需要维护连接状态的，因而不需要每对连接建立一组Socket，而是只要有一个Socket，就能够和多个客户端通信。

## 网络层

网络层（Network Layer）是OSI模型的第三层，提供路由与寻址的功能，使两端系统能够互连并决定最终路径，并具有一定的拥塞控制和流量控制的能够力。

### 1. 存在意义

- 提供路由与寻址
- 寻找最佳路径
- 拥塞控制和流量控制

### 2. 协议

#### # ICMP

ICMP全程**Internet Control Message Protocal**，也就是**互联网报文控制协议**。

ICMP主要的使用方式有两种：

- 查询报文类型：常见的**Ping**就是主动请求并获取主动应答的ICMP协议。
- 差错报文类型：故意发送一些错误的包，从而获取路由中的一些信息，比如到最近一跳所需花的时间，带宽。常见的如**Traceroute**。

### 3. 设备

#### # 网关

网关往往是一个路由器，是一个三层转发设备，一般是某一个网段的第一和或者第二个。

#### # 路由器

路由器是一个三层设备，它里面通常有多张网卡，里面有如何寻找下一跳的规则。**经过路由器之后的MAC头会变，IP地址可变可不变，变的情况就是NAT**。

## 数据链路层

数据链路层，也称**MAC（Mudium Access Control）**,即**媒体访问控制**。

### 1. 存在意义

该层能够解决的问题：

- 定制发送规则：**随机接入协议**
- 发送双方的确定：利用**MAC头**确定接送双方

- 错误检测：第二层的后面是最后是**CRC**，用来进行循环冗余检测

### 2. 相关协议

#### # ARP协议

ARP协议是通过解析**网络层地址**获取**数据链路层地址**的网络传输协议。

#### # RARP

RARP协议是通过解析**数据链路层地址**获取**网络层地址**的网络传输协议。

#### # STP

STP协议可以解决交换机中的环路问题，将由环路的图变成没有环路的树。

 ### 3. 相关设备

#### # 交换机

它有一个**转发表**可以记下哪个口对应的MAC地址设备。所以交换机是有学习能力，经过第一次转发以后，它就会记录某个口对应的MAC地址。

交换机数目过多的时候，我们可以使用**物理隔离**或者使用**虚拟隔离**，也就是我们平时所说的**VLAN（虚拟局域网）**。

## 物理层

主要定义物理设备标准，如网线的接口类型、光纤的接口类型、各种传输介质的传输速率等。

### 1. 存在意义

传输比特流

### 2. 相关设备

#### # 集线器

有一种设备叫做**集线器（Hub）**，它工作在物理层，负责将信号广播到附近的设备。